---
title: "Pogen Analytics"
output:
  rmdformats::material:
    highlight: kate
    self_contained: true
    code_folding: show
    thumbnails: true
    gallery: true
    fig_width: 4
    fig_height: 4
    df_print: kable
---


```{r knitr_init, echo=FALSE, results="asis", cache=FALSE, include=F}
library(knitr)
library(rmdformats)
library(questionr)
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(arules)
library(arulesViz)
library(RColorBrewer)
library(dplyr, warn.conflicts = F)
library(lubridate, warn.conflicts = F)
library(knitr, warn.conflicts = F)
library(kableExtra)
library(ggpubr)
library(ggplot2)
library(plyr)
library(DT)
library(tidyverse)
library(readxl)
library(plotly)
```

# Introducción

## Market Basket Analysis

El Market Basket Analysis, es utilizado en la industria del retail e e-commerce para entender el comportamiento de compra de los clientes. Esta metodología detecta las combinaciones de artículos que suelen comprar al mismo tipo. 

Pogen Analytics pone a tu disposición 3 demos para que conozcas nuestra plataforma de Market Basket Análysis y los beneficios que puede traer a tu negocio:

* Demo 1: Supermercado
* Demo 2: Zapatería
* Demo 3: Tienda Departamental

A través de los diferentes demos podrás analisar su Market Basket Análysis y las recomendaciones que Pogen Analytics suguiere para resolver cada uno de sus casos.

# Demo 1

## Supermercado Intermarche {.tabset}

La compra de productos de supermercado online alrededor del mundo ya es una tendencia, en México es el que tiene mayor frecuencia de compra semanal con el 23% entre todas las categorías de compra en línea. 

Debido a la importancia que va cobrando la compra del supermercado vía online, Supermercado Intermarche busca ofrecer a sus clientes una mejor experiencia de compra agregando a su portal una sección donde sus clientes puedan comprar paquetes de productos recomendados.

Además busca una solución para generar sus ofertas de 2x1 y 3x2 de acuerdo al comportamiento de sus clientes, asegurando asi su éxito. 

```{r , include=FALSE}

data <- read.csv(file = "data_super_esp.csv")
data <- select(.data = data, BASKET_ID, COMMODITY_DESC)
names(data) <- c("ticket","items")

```

### Análisis de Ventas

```{r include = FALSE}
        data$ticket <- as.character(data$ticket)
        data$items <- as.character(data$items)
        
        transaction <- ddply(data,
                             c("ticket"),
                             function(df1)paste(df1$items, collapse = ","))
        
        transaction <- transaction$V1
        
        write.table(x = transaction,
                    file = tmp <- file(),
                    row.names = FALSE,
                    quote = FALSE)
        
        trans <- read.transactions(file = tmp,
                          format = "basket",
                          sep = ",", 
                          rm.duplicates=TRUE)
        
        resume <- summary(trans)
        no_trans <- resume@Dim[1]
        no_ticket <- resume@Dim[2]
```

Para realizar el Market Basket Análisis se utilizó una base de datos de `r no_trans` transacciones y `r no_ticket` artículos, el cual representa una semana de ventas del supermercado.

**Productos más vendidos**

```{r, echo=F, include=T, fig.width=7, out.width="100%"}
        freq <- data.frame(table(data$items)) 
        freq <- freq[order(freq$Freq, decreasing = T),]
        total <- sum(freq$Freq)
        freq <- freq[1:10,]
        names(freq) <- c("items","count")
        freq$items <- as.character(freq$items)
        relativo <- c(rel = round(freq$count/total,4))
        relativo <- paste(round(100*relativo,2), "%", sep="")
        freq <- data.frame(freq,relativo)
        
        plot_ly(freq, x = reorder(freq$items, -freq$count), y = freq$count, type = "bar",
                text = relativo, textposition = "outside", showlegend = F, name = " ",
                cliponaxis = FALSE,
                marker = list(color = "#235a79")) %>%
            layout(title = list(tittle = ""),
                   xaxis = list(title = "", tickangle = -45),
                   yaxis = list(title = ""))
```

**Tamaños de tickets de compra**

```{r, echo=F, include=T, fig.width=7, out.width="100%"}
        freq <- data.frame(table(data$ticket)) 
        freq <- freq[order(freq$Freq, decreasing = T),]
        freq <- data.frame(table(freq$Freq))
        freq <- freq[order(freq$Freq, decreasing = T),]
        if(nrow(freq)>10){
            freq <- freq[1:10,]
        }
        names(freq) <- c("size","count")
        total <- sum(freq$count)
        rela <- c(rel = round(freq$count/total,4))
        rela<- paste(round(100*rela,2), "%", sep="")
        
        plot_ly(freq, x = reorder(freq$size, -freq$count), y = freq$count, type = "bar",
                text = rela, textposition = "outside", showlegend = F, name = " ",
                cliponaxis = FALSE,
                marker = list(color = "#f04438")) %>%
            layout(title = "",
                   xaxis = list(title = "", tickangle = -45),
                   yaxis = list(title = ""))
```
        
### Market Basket

```{r, echo=F, include=F}
soporte <- 4/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 4,
                                           target = "rules"))
        reglas <- reglas[is.maximal(reglas)]
        reglas <- sort(reglas, by = "count", decreasing = T)
```

**Reglas de asociación**

Una regla de asociación se define como una implicación del tipo “si X entonces Y” (X⇒Y). Por ejemplo, la regla {Leche} => {Cereal}  significa que, cuando compran CALZADO, también compran CORRER. El lado izquierdo de la regla recibe el nombre de antecedente (LHS) y el lado derecho el nombre de consecuente (RHS).

El porcentaje de confiabilidad es la probabilidad de que una transacción que contiene los items  X, también contengan los items de Y. Por ejemplo, el 20% de las veces que se compra leche también se compra cereal.

```{r, echo=F, include=T, out.width="100%"}
top.count <- sort(reglas, by = "count", decreasing = T)
        
        cut <- unlist(strsplit(labels(top.count), "=>"))
        
        lhs <- data.frame(lhs = cut[seq(1,length(cut),2)])
        rhs <- data.frame(rhs = cut[seq(2,length(cut),2)])
        igual <- as.data.frame(matrix(nrow=(length(cut)/2), ncol = 1))
        igual[,1] <- "=>"
        names(igual) <- "=>"
        quality <- data.frame(top.count@quality)
        confidence <- data.frame(quality$confidence)
        count <- data.frame(quality$count)
        tabla <- data.frame(lhs, igual, rhs, confidence, count)
        names(tabla) <- c("lhs","=>","rhs","% Conf", "count")
        tabla <- tabla[order(tabla$count, decreasing = T),] %>%
            filter(tabla$count > 3)
        
        datatable(data = tabla, rownames = F, options = list(pageLength = 5)) %>%
            formatPercentage(columns = "% Conf", digits = 1)
```

**Grafo de Reglas**

Las gráficas son una excelente manera de visualizar cómo los artículos que se relacionan entre sí. Las reglas están representadas dentro los círculos y estos, a su vez, están conectados con sus artículos mediante flechas.

```{r, echo=F, include=T, fig.width=7, warning=F, , out.width="100%"}
support <- 4/dim(trans)[1]
        
        rules <- apriori(data = trans,
                         parameter = list(supp=support, conf=0.0001, minlen =2, maxlen = 4),
                         control = list(verbose = FALSE))
        
        rules <- rules[is.maximal(rules)]
        
        rules <- sort(rules, by = "count", decreasing = T)
        
        plot(rules, method="graph",engine = "htmlwidget")
```

### Solución 1

**Conjunto de productos**

Supermercado Intermarché puede recomendar a sus clientes agregar a su carrito de compra un conjunto de artículos con un solo click, de esta manera se simplifica el proceso de estar agregando artículos por artículo.

```{r, echo=F, include=F}
soporte <- 4/dim(trans)[1]
        itemsets <- apriori(data = trans,
                            parameter = list(support = soporte,
                                             minlen = 3,
                                             target = "frequent itemset"))
        
        itemsets <- itemsets[is.maximal(itemsets)]
        itemsets <- sort(itemsets, decreasing = T)

```


```{r, echo=F, include=T, out.width="100%"}

itemsets <- as(itemsets, Class = "data.frame")
itemsets <- select(.data = itemsets, !support)
        itemsets <- itemsets[order(itemsets$count,decreasing = T),]
        
        datatable(data = itemsets, rownames = F)
```

### Solución 2

El supermercado Intermarche tiene la oportunidad de ofrecer productos gratis en la compra de otros productos. Para poder determinar cuáles promociones tendrán mayor éxito se utilizan las reglas de asociación más confiables y frecuentes.

**Promociones 2x1**

Las promociones 2x1 que supermercado Intermarché puede ofrecer son:

```{r, echo=F, include=T, out.width="100%"}
soporte <- 4/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 2,
                                           target = "rules"),
                          control = list(verbose=F))
        reglas <- reglas[is.maximal(reglas)]
        reglas <- sort(reglas, by = "count", decreasing = T)
        
metricas <- interestMeasure(x = reglas, measure = c("coverage", "fishersExactTest"),
                                    transactions = trans)
        quality(reglas) <- cbind(quality(reglas), metricas)
        df_reglas <- as(reglas, Class = "data.frame")
        
        df_fishers <- select(.data = df_reglas, rules, confidence, count, fishersExactTest)
        df_fishers <- df_fishers[order(df_fishers$fishersExactTest, decreasing = F),]
        df_fishers <- filter(.data = df_fishers, df_fishers$fishersExactTest < 0.05)
        names(df_fishers) <- c("rules","confidence","count","fisherExactRest")
        
        promo2x1 <- as.data.frame(matrix(nrow = 0, ncol = 4))
        names(promo2x1) <- c("rules","confidence","count","fisherExactRest")
        
        sec <- seq(1,nrow(df_fishers),2)
        
        for(i in sec){
                if(df_fishers[i,2]>df_fishers[i+1,2]){
                        promo2x1 <- rbind(promo2x1, df_fishers[i,])
                } else {
                        promo2x1 <- rbind(promo2x1, df_fishers[i+1,])
                }
        }
        
        promo2x1$confidence <- round(promo2x1$confidence, 4)
        promo2x1 <- select(.data = promo2x1, !fisherExactRest)
        
        datatable(data = promo2x1, rownames = F, options = list(pageLength = 5))%>%
            formatPercentage(columns = "confidence", digits = 1)
```

**Promociones 3x2**

Las promociones 3x2 que el supermercados Intermarché puede ofrecer son:

```{r, echo=F, include=T, out.width="100%"}
soporte <- 4/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 3,
                                           maxlen = 3,
                                           target = "rules"),
                          control = list(verbose=F))
        reglas <- reglas[is.maximal(reglas)]
        reglas <- sort(reglas, by = "count", decreasing = T)
        
metricas <- interestMeasure(x = reglas, measure = c("coverage", "fishersExactTest"),
                                    transactions = trans)
        quality(reglas) <- cbind(quality(reglas), metricas)
        df_reglas <- as(reglas, Class = "data.frame")
        
        df_fishers <- select(.data = df_reglas, rules, confidence, count, fishersExactTest)
        df_fishers <- df_fishers[order(df_fishers$fishersExactTest, decreasing = F),]
        df_fishers <- filter(.data = df_fishers, df_fishers$fishersExactTest < 0.05)
        names(df_fishers) <- c("rules","confidence","count","fisherExactRest")
        
        promo3x2 <- filter(.data = df_fishers, confidence == 1)
        promo3x2$confidence <- round(promo3x2$confidence, 4)
        
        promo3x2 <- select(promo3x2, !fisherExactRest)
        
        datatable(data = promo3x2, rownames = F, options = list(pageLength = 5))%>%
            formatPercentage(columns = "confidence", digits = 1)
```

## {-}


# Demo 2

## Zapateria Ivonne {.tabset}

La zapateria Ivonne cuenta con 20 sucursales a nivel nacional, y busca ofrecer a sus vendedores de piso una plataforma donde puedan visualizar la relación que hay entre productos, de esta manera ellos puedan conocer qué artículos ofrecer de acuerdo al modelo que su cliente está a punto de comprar y asi aumentar sus tamaños de ticket de venta.

Además busca una solución para generar promociones entre accesorios y zapatos de acuerdo al comportamiento de sus clientes. 

```{r , include=FALSE}

data <- read.csv(file = "data_zapatos.csv", colClasses = "character")
names(data) <- c("ticket","items")

```


### Análisis de Ventas

```{r, include = FALSE}
        data$ticket <- as.character(data$ticket)
        data$items <- as.character(data$items)
        
        transaction <- ddply(data,
                             c("ticket"),
                             function(df1)paste(df1$items, collapse = ","))
        
        transaction <- transaction$V1
        
        write.table(x = transaction,
                    file = tmp <- file(),
                    row.names = FALSE,
                    quote = FALSE)
        
        trans <- read.transactions(file = tmp,
                          format = "basket",
                          sep = ",", 
                          rm.duplicates=TRUE)
        
        resume <- summary(trans)
        no_trans <- resume@Dim[1]
        no_ticket <- resume@Dim[2]
```

Para realizar el Market Basket Análisis se utilizó una base de datos de `r no_trans` transacciones y `r no_ticket` artículos, que corresponden a las ventas del 2019 en una de las sucursales. En las siguientes gráficas se muestran los productos más vendidos y el tamaño de ticket más frecuente.

**Productos más vendidos**

```{r, echo=F, include=T, fig.width=7, out.width="100%"}
        freq <- data.frame(table(data$items)) 
        freq <- freq[order(freq$Freq, decreasing = T),]
        total <- sum(freq$Freq)
        freq <- freq[1:10,]
        names(freq) <- c("items","count")
        freq$items <- as.character(freq$items)
        relativo <- c(rel = round(freq$count/total,4))
        relativo <- paste(round(100*relativo,2), "%", sep="")
        freq <- data.frame(freq,relativo)
        
        plot_ly(freq, x = reorder(freq$items, -freq$count), y = freq$count, type = "bar",
                text = relativo, textposition = "outside", showlegend = F, name = " ",
                cliponaxis = FALSE,
                marker = list(color = "#235a79")) %>%
            layout(title = list(tittle = ""),
                   xaxis = list(title = "", tickangle = -45),
                   yaxis = list(title = ""))
```

**Tamaños de tickets de compra**

```{r, echo=F, include=T, fig.width=7, out.width="100%"}
        freq <- data.frame(table(data$ticket)) 
        freq <- freq[order(freq$Freq, decreasing = T),]
        freq <- data.frame(table(freq$Freq))
        freq <- freq[order(freq$Freq, decreasing = T),]
        if(nrow(freq)>10){
            freq <- freq[1:10,]
        }
        names(freq) <- c("size","count")
        total <- sum(freq$count)
        rela <- c(rel = round(freq$count/total,4))
        rela<- paste(round(100*rela,2), "%", sep="")
        
        plot_ly(freq, x = reorder(freq$size, -freq$count), y = freq$count, type = "bar",
                text = rela, textposition = "outside", showlegend = F, name = " ",
                cliponaxis = FALSE,
                marker = list(color = "#f04438")) %>%
            layout(title = "",
                   xaxis = list(title = "", tickangle = -45),
                   yaxis = list(title = ""))
```
        
### Market Basket

```{r, echo=F, include=F}
soporte <-50/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 4,
                                           target = "rules"),
                          control = list(verbose=F))
        reglas <- reglas[is.maximal(reglas)]
        reglas <- sort(reglas, by = "count", decreasing = T)
```

**Reglas de asociación**

Una regla de asociación se define como una implicación del tipo “si X entonces Y” (X⇒Y). Por ejemplo, la regla {Tenis} => {Agujetas}  significa que, cuando compran Tenis, también compran Agujetas. El lado izquierdo de la regla recibe el nombre de antecedente (LHS) y el lado derecho el nombre de consecuente (RHS).

El porcentaje de confiabilidad es la probabilidad de que una transacción que contiene los items  X, también contengan los items de Y. Por ejemplo, el 20% de las veces que se compra Tenis también se compra Agujetas.

```{r, echo=F, include=T, out.width="100%"}
top.count <- sort(reglas, by = "count", decreasing = T)
        
        cut <- unlist(strsplit(labels(top.count), "=>"))
        
        lhs <- data.frame(lhs = cut[seq(1,length(cut),2)])
        rhs <- data.frame(rhs = cut[seq(2,length(cut),2)])
        igual <- as.data.frame(matrix(nrow=(length(cut)/2), ncol = 1))
        igual[,1] <- "=>"
        names(igual) <- "=>"
        quality <- data.frame(top.count@quality)
        confidence <- data.frame(quality$confidence)
        count <- data.frame(quality$count)
        tabla <- data.frame(lhs, igual, rhs, confidence, count)
        names(tabla) <- c("lhs","=>","rhs","% Conf", "count")
        tabla <- tabla[order(tabla$count, decreasing = T),] %>%
            filter(tabla$count > 3)
        
        datatable(data = tabla, rownames = F, options = list(pageLength = 5)) %>%
            formatPercentage(columns = "% Conf", digits = 1)
```

**Grafo de Reglas**

Las gráficas son una excelente manera de visualizar cómo los artículos que se relacionan entre sí. Las reglas están representadas dentro los círculos y estos, a su vez, están conectados con sus artículos mediante flechas.

```{r, echo=F, include=T, fig.width=7, warning=F, , out.width="100%"}
support <- 10/dim(trans)[1]
        
        rules <- apriori(data = trans,
                         parameter = list(supp=support, conf=0.01, minlen =2),
                         control = list(verbose = FALSE))
        
        rules <- rules[is.maximal(rules)]
        
        rules <- sort(rules, by = "count", decreasing = T)
        
        plot(rules, method="graph",engine = "htmlwidget")
```

### Solución 1

**Plataforma de venta**

Los vendedores de piso son los empleados que más deben estar informados del comportamiento de sus clientes y de esta manera impulsar sus ventas. El/Ella puede ir a su plataforma y teclear el tipo de zapato que su cliente se está llevando y saber que otro producto ofrecerle.

La clienta de Carolina se está probando Tenis por lo tanto le debe ofrecer:
```{r, echo=F, include=T, out.width="100%"}
soporte <- 1/dim(trans)[1]
        itemsets <- apriori(data = trans,
                            parameter = list(support = soporte,
                                             confidence = 0.01,
                                             minlen = 2,
                                             maxlen = 2),
                            appearance = list(default = "rhs",lhs="TENIS"),
                            control = list(verbose=F))
      
        itemsets <- sort(itemsets, decreasing = T)
        
        itemsets <- as(itemsets, Class = "data.frame")
        itemsets <- select(.data = itemsets, rules, confidence, count)
        itemsets$confidence <- round(itemsets$confidence,4)
        itemsets <- itemsets[order(itemsets$count,decreasing = T),]
        itemsets <- itemsets[c(1,2,5),]
        
        datatable(data = itemsets, rownames = F)%>%
          formatPercentage(columns = "confidence", digits = 1)
```

La clienta de Eduardo se está probando unas balerinas, por lo tanto debe de ofrecer:
```{r, echo=F, include=T, out.width="100%"}
soporte <- 1/dim(trans)[1]
        itemsets <- apriori(data = trans,
                            parameter = list(support = soporte,
                                             confidence = 0.01,
                                             minlen = 2,
                                             maxlen = 2),
                            appearance = list(default = "rhs",lhs="BALERINAS"),
                            control = list(verbose=F))
      
        itemsets <- sort(itemsets, decreasing = T)
        
        itemsets <- as(itemsets, Class = "data.frame")
        itemsets <- select(.data = itemsets, rules, confidence, count)
        itemsets$confidence <- round(itemsets$confidence,4)
        itemsets <- itemsets[order(itemsets$count,decreasing = T),]
        itemsets <- itemsets[c(1,4,6),]
        
        datatable(data = itemsets, rownames = F)%>%
          formatPercentage(columns = "confidence", digits = 1)
```

### Solucion 2

**Promociones Zapatos-Accesorios**

La zapateria Ivonne ha tenido gran exito en su venta de accesorios y busca generar una promoción donde sus clientes compren Zapatos y obtengan un accesorio en descuento o gratis. Las mejores 10 combinaciones de productos que el analisis arrojó fueron las siguientes.

```{r, echo=F, include=T, out.width="100%"}
accesorios <- c("AGUJETAS","BOLSA","COSMETIQUERA","LENTES","LLAVERO","MOCHILA","MONEDERO","PERFUME","PLANTILLAS")
soporte <-1/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 2),
                          appearance = list(default="lhs",rhs = accesorios),
                          control = list(verbose=F))
        reglas <- reglas[is.maximal(reglas)]
        promo2x1 <- sort(reglas, by = "count", decreasing = T)
        
        promo2x1 <- as(promo2x1, Class = "data.frame")
        promo2x1 <- select(.data = promo2x1, rules, confidence, count)
        promo2x1 <- promo2x1[1:10,]
        
        datatable(data = promo2x1, rownames = F)%>%
            formatPercentage(columns = "confidence", digits = 1)
```

## {-}

# Demo 3

## Sport Tienda {.tabset}

La tienda departamental Action Sports busca renovar sus diferentes sucursales físicas y online, de acuerdo al comportamiento de compra de sus clientes. De esta manera, el cliente encontrará los artículos que más compra cerca uno del otro, además de ofrecer artículos de interes alrededor. 

Además, busca una manera eficiente de disminuir sus inventarios cuando se acaba una temporada de Primavera-Verano o Otoño-Invierno creando promociones tanto para tiendas físicas como online.

```{r , include=FALSE}

data <- read.csv(file = "data_deportes.csv", colClasses = "character")
names(data) <- c("ticket","items")

```


### Análisis de Ventas

```{r, include = FALSE}
        data$ticket <- as.character(data$ticket)
        data$items <- as.character(data$items)
        
        transaction <- ddply(data,
                             c("ticket"),
                             function(df1)paste(df1$items, collapse = ","))
        
        transaction <- transaction$V1
        
        write.table(x = transaction,
                    file = tmp <- file(),
                    row.names = FALSE,
                    quote = FALSE)
        
        trans <- read.transactions(file = tmp,
                          format = "basket",
                          sep = ",", 
                          rm.duplicates=TRUE)
        
        resume <- summary(trans)
        no_trans <- resume@Dim[1]
        no_ticket <- resume@Dim[2]
```

Para realizar el Market Basket Análisis se utilizó una base de datos de `r no_trans` transacciones y `r no_ticket` artículos. En las siguientes gráficas se muestran los productos más vendidos y el tamaño de ticket más frecuente.

**Productos más vendidos**

```{r, echo=F, include=T, fig.width=7, out.width="100%"}
        freq <- data.frame(table(data$items)) 
        freq <- freq[order(freq$Freq, decreasing = T),]
        total <- sum(freq$Freq)
        freq <- freq[1:10,]
        names(freq) <- c("items","count")
        freq$items <- as.character(freq$items)
        relativo <- c(rel = round(freq$count/total,4))
        relativo <- paste(round(100*relativo,2), "%", sep="")
        freq <- data.frame(freq,relativo)
        
        plot_ly(freq, x = reorder(freq$items, -freq$count), y = freq$count, type = "bar",
                text = relativo, textposition = "outside", showlegend = F, name = " ",
                cliponaxis = FALSE,
                marker = list(color = "#235a79")) %>%
            layout(title = list(tittle = ""),
                   xaxis = list(title = "", tickangle = -45),
                   yaxis = list(title = ""))
```

**Tamaños de tickets de compra**

```{r, echo=F, include=T, fig.width=7, out.width="100%"}
        freq <- data.frame(table(data$ticket)) 
        freq <- freq[order(freq$Freq, decreasing = T),]
        freq <- data.frame(table(freq$Freq))
        freq <- freq[order(freq$Freq, decreasing = T),]
        if(nrow(freq)>10){
            freq <- freq[1:10,]
        }
        names(freq) <- c("size","count")
        total <- sum(freq$count)
        rela <- c(rel = round(freq$count/total,4))
        rela<- paste(round(100*rela,2), "%", sep="")
        
        plot_ly(freq, x = reorder(freq$size, -freq$count), y = freq$count, type = "bar",
                text = rela, textposition = "outside", showlegend = F, name = " ",
                cliponaxis = FALSE,
                marker = list(color = "#f04438")) %>%
            layout(title = "",
                   xaxis = list(title = "", tickangle = -45),
                   yaxis = list(title = ""))
```
        
### Market Basket

```{r, echo=F, include=F}
soporte <-300/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 4,
                                           target = "rules"),
                          control = list(verbose=F))
        reglas <- reglas[is.maximal(reglas)]
        reglas <- sort(reglas, by = "count", decreasing = T)
```

**Reglas de asociación**

Una regla de asociación se define como una implicación del tipo “si X entonces Y” (X⇒Y). Por ejemplo, la regla {Futbol} => {Calzado}  significa que, cuando compran Leche, también compran Cereal. El lado izquierdo de la regla recibe el nombre de antecedente (LHS) y el lado derecho el nombre de consecuente (RHS).

El porcentaje de confiabilidad es la probabilidad de que una transacción que contiene los items  X, también contengan los items de Y. Por ejemplo, el 20% de las veces que se compra Futbol también se compra Calzado.

```{r, echo=F, include=T, out.width="100%"}
top.count <- sort(reglas, by = "count", decreasing = T)
        
        cut <- unlist(strsplit(labels(top.count), "=>"))
        
        lhs <- data.frame(lhs = cut[seq(1,length(cut),2)])
        rhs <- data.frame(rhs = cut[seq(2,length(cut),2)])
        igual <- as.data.frame(matrix(nrow=(length(cut)/2), ncol = 1))
        igual[,1] <- "=>"
        names(igual) <- "=>"
        quality <- data.frame(top.count@quality)
        confidence <- data.frame(quality$confidence)
        count <- data.frame(quality$count)
        tabla <- data.frame(lhs, igual, rhs, confidence, count)
        names(tabla) <- c("lhs","=>","rhs","% Conf", "count")
        tabla <- tabla[order(tabla$count, decreasing = T),] %>%
            filter(tabla$count > 3)
        
        datatable(data = tabla, rownames = F, options = list(pageLength = 5)) %>%
            formatPercentage(columns = "% Conf", digits = 1)
```

**Grafo de Reglas**

Las gráficas son una excelente manera de visualizar cómo los artículos que se relacionan entre sí. Las reglas están representadas dentro los círculos y estos, a su vez, están conectados con sus artículos mediante flechas.

```{r, echo=F, include=T, fig.width=7, warning=F, , out.width="100%"}
support <- 100/dim(trans)[1]
        
        rules <- apriori(data = trans,
                         parameter = list(supp=support, conf=0.0001, minlen =2),
                         control = list(verbose = FALSE))
        
        rules <- rules[is.maximal(rules)]
        
        rules <- sort(rules, by = "count", decreasing = T)
        
        plot(rules, method="graph",engine = "htmlwidget")
```

### Solución 1

```{r, echo=F, include=F}
soporte <- 100/dim(trans)[1]
        itemsets <- apriori(data = trans,
                            parameter = list(support = soporte,
                                             minlen = 3,
                                             target = "frequent itemset"))
        
        itemsets <- itemsets[is.maximal(itemsets)]
        itemsets <- sort(itemsets, decreasing = T)

```

*Pendiente todavía de procesar los datos.*

### Solución 2

Los productos que Action Sport busca agotar en sus intentarios son: Yoga, Deporte Acuático y Futbol Americano. Su estrategia es ofrecer estos productos en descuento en la compra de otro producto. La combinaciones de promociones se basará en el comportamiento de sus ventas durante la temporada.

**YOGA**

```{r, echo=F, include=T, out.width="100%"}
soporte <-1/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 2),
                          appearance = list(default="rhs",lhs = "YOGA"),
                          control = list(verbose=F))
       reglas <- reglas[is.maximal(reglas)] 
        promo2x1 <- sort(reglas, by = "count", decreasing = T)
        
        promo2x1 <- as(promo2x1, Class = "data.frame")
        promo2x1 <- select(.data = promo2x1, rules, confidence, count)
        promo2x1 <- promo2x1[1:5,]
        
        datatable(data = promo2x1, rownames = F)%>%
            formatPercentage(columns = "confidence", digits = 1)
```

**DEPORTE ACUATICO**

```{r, echo=F, include=T, out.width="100%"}
soporte <-1/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 2),
                          appearance = list(default="rhs",lhs = "DEPORTE ACUATICO"),
                          control = list(verbose=F))
       reglas <- reglas[is.maximal(reglas)] 
        promo2x1 <- sort(reglas, by = "count", decreasing = T)
        
        promo2x1 <- as(promo2x1, Class = "data.frame")
        promo2x1 <- select(.data = promo2x1, rules, confidence, count)
        promo2x1 <- promo2x1[1:5,]
        
        datatable(data = promo2x1, rownames = F)%>%
            formatPercentage(columns = "confidence", digits = 1)
```

**FUTBOL AMERICANO**

```{r, echo=F, include=T, out.width="100%"}
soporte <-1/dim(trans)[1]
        reglas <- apriori(data = trans,
                          parameter = list(support = soporte,
                                           confidence = 0.01,
                                           minlen = 2,
                                           maxlen = 2),
                          appearance = list(default="rhs",lhs = "FUTBOL AMERICANO"),
                          control = list(verbose=F))
       reglas <- reglas[is.maximal(reglas)] 
        promo2x1 <- sort(reglas, by = "count", decreasing = T)
        
        promo2x1 <- as(promo2x1, Class = "data.frame")
        promo2x1 <- select(.data = promo2x1, rules, confidence, count)
        promo2x1 <- promo2x1[1:5,]
        
        datatable(data = promo2x1, rownames = F)%>%
            formatPercentage(columns = "confidence", digits = 1)
```

## {-}


